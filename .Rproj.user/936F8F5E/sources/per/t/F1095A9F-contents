---
title: "Beyond MLR Lab 6"
author: "Ba Khuong Cao"
format: 
  html:
    toc: true
    toc-depth: 3
    embed-resources: true
execute:
  eval: true
  echo: true
  warning: false
  message: false
---

NotePreliminary setup
In this lab, we will use the R packages haven, ggplot2, dplyr, emmeans, lmerTest. You can use the script below to automatically install and load them using the pacman package.
```{r}
# Check whether pacman is available and install if needed
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")

# Use pacman to install (if needed) and load the required packages
pacman::p_load(haven, dplyr, ggplot2, emmeans, lmerTest)
```

Adolescent alcohol use data
In this lab, we will explore the analysis of longitudinal data using linear mixed-effects models. Longitudinal data involve repeated measurements taken on the same subjects over time, allowing us to study changes in outcomes within individuals.

The dataset we will use comes from a study of adolescent alcohol use, featured in Singer and Willett’s Applied Longitudinal Data Analysis: Modeling Change and Event Occurrence (2003). This study tracked 82 adolescents over three years (ages 14, 15, and 16) to examine how their alcohol use changed over time.

Dataset description
The dataset contains the following variables:

Outcome variable:
alcuse: Continuous measure of alcohol use based on various survey items.
Grouping variable:
id: Unique identifier for each adolescent in the study.
Covariates:
coa: Dichotomous variable indicating parental alcoholism (1 = yes, 0 = no).
sex: Dichotomous variable indicating sex.
peer: Continuous measure of peer alcohol use, assessed at age 14.
age: Numerical variable representing the age of the adolescent at each time point (14, 15, 16).
Research question
In this lab, we are going to address the following research question:

What factors predict adolescent alcohol use and its change over time? Specifically, do parental alcoholism, sex, and peer alcohol use influence baseline levels and trajectories of alcohol use from ages 14 to 16?

Data import, cleaning, and inspection


```{r}
# Load the adolescent alcohol use data
# Note: the call below assumes the dataset is placed in the 'data' folder
# directly above the root folder of the project. Update the path as needed.
alcohol_data <- read_sav("alcoholpp.sav")

# Convert labelled variables (dbl+lbl) to factors using their value labels
alcohol_data <- alcohol_data |> mutate(across(where(is.labelled), as_factor))

# Use effects coding for the categorical variables
options(contrasts = c("contr.sum", "contr.poly"))

# Inspect the structure of the dataset
str(alcohol_data)
```

Exploratory data analysis
Overall pattern and individual variation
We begin by examining both the overall mean trajectory and individual trajectories simultaneously. This “spaghetti plot” shows all individual trajectories (thin gray lines) overlaid with the overall mean trajectory (thick blue line), providing an immediate sense of both the average pattern and the variability around it.

```{r}

# Compute the overall mean alcohol use by age
mean_trajectory <- alcohol_data |>
  group_by(age) |>
  summarise(mean_alcuse = mean(alcuse, na.rm = TRUE), .groups = "drop")

# Create spaghetti plot: individual trajectories + mean trajectory
ggplot(alcohol_data, aes(x = age, y = alcuse)) +
  geom_line(aes(group = id), alpha = 0.3, color = "gray60") +  # Individual trajectories
  geom_line(data = mean_trajectory, aes(x = age, y = mean_alcuse), 
            color = "steelblue", linewidth = 1.5) +             # Mean trajectory
  geom_point(data = mean_trajectory, aes(x = age, y = mean_alcuse), 
             color = "steelblue", size = 3) +                   # Mean points
  labs(
    title = "Individual and Mean Alcohol Use Trajectories",
    subtitle = "Gray lines = individual trajectories; Blue line = overall mean",
    x = "Age",
    y = "Alcohol Use"
  ) +
  theme_minimal()

```

Question
Based on the spaghetti plot:

Does the change in alcohol use over time appear to be linear, or would a quadratic trend be more appropriate?

K Answer: The change in alcohol use over time appear to be linear, where the alcohol use increase with the higher age. There would be a quadratic trend.

How much variability is there in individual trajectories around the mean? Does this variability suggest the need for random effects in our models?

K Answer: There is a large variability in individual trajectories around the mean. This variability could suggest the need for random effects in our models.


Examining individual trajectories in detail
While the spaghetti plot gives us a good overview of the overall variability, it can be difficult to distinguish specific individual patterns when all trajectories are overlaid. To get a better sense of the different types of individual trajectories, we’ll examine a random sample of 16 individuals using a facet plot.


```{r}
set.seed(123)  # Set seed for reproducibility

# Sample 16 unique individuals
sampled_ids <- sample(1:82, 16)

# Filter dataset for the sampled IDs and plot
alcohol_data |>
  filter(id %in% sampled_ids) |>
  ggplot(aes(x = age, y = alcuse)) +
  geom_line() +                               # Add trajectories (lines)
  geom_point(size = 2, alpha = 0.7) +         # Add individual data points (dots)
  facet_wrap(~ id) +                          # Create a subplot for each individual
  labs(
    title = "Sample of Individual Alcohol Use Trajectories",
    x = "Age",
    y = "Alcohol Use"
  ) +
  theme_minimal()
```
Observations:
Many adolescents report no alcohol use (alcuse = 0) across all time points.
For adolescents who do report alcohol use, the trajectories show diverse patterns: some increasing, some decreasing, and some remaining relatively stable over time.
The heterogeneity in both baseline levels and rates of change motivates the use of random intercepts and random slopes in our models.



WarningDisclaimer
The dataset used in this lab is zero-inflated, with a large number of zero alcohol use values. While linear mixed-effects models are not necessarily the best approach for analyzing such data, we will use them in this lab to focus on the methodology. The results derived in this lab are intended for educational purposes only.

Mean trajectories by parental alcoholism
Next, we will examine the mean trajectories of alcohol use by parental alcoholism (coa). This will provide an overview of how this variable relates to alcohol use over time.

```{r}
# Compute the mean alcohol use by age, and COA status
mean_alcuse <- alcohol_data |>
  group_by(age, coa) |>
  summarise(mean_alcuse = mean(alcuse, na.rm = TRUE), .groups = "drop")

# Plot the mean trajectories by COA
ggplot(mean_alcuse, aes(x = age, y = mean_alcuse, color = coa)) +
  geom_line() +
  labs(
    title = "Mean Alcohol Use Trajectories by Parental Alcoholism",
    x = "Age",
    y = "Mean Alcohol Use"
  ) +
  ylim(0, 3) +
  theme_minimal()
```
Based on the plot, do you expect there to be a effect of parental alcoholism on alcohol use? Do you expect there to be an interaction effect between parental alcoholism and age? Explain your reasoning based on the trends shown in the plot.



Create similar plots to explore mean trajectories by sex and by peer alcohol use.











Hint for peer alcohol use: Since peer is a continuous variable, you can categorize it into tertiles (low, medium, high) for visualization purposes using the following code:
```{r}
alcohol_data <- alcohol_data |>
  mutate(peer_cat = cut(peer,
                        breaks = quantile(peer, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
                        labels = c("Low", "Medium", "High"),
                        include.lowest = TRUE))
```

Modeling the time structure
Before adding covariates, we first establish the appropriate model for time. This “time structure first” approach ensures that we correctly capture how the outcome changes over time before investigating what factors might explain individual differences.

Step 1: Fit a flexible model for time
We start with a model that includes:

Saturated fixed effects for time: linear and quadratic terms (with 3 time points, this perfectly captures the mean trajectory)
Random intercept and random slope: allowing individuals to differ in both their baseline level and their rate of change

```{r}
# Center age at 15 (middle time point)
alcohol_data$age_centered <- alcohol_data$age - 15

# Create quadratic term
alcohol_data$age_centered_sq <- alcohol_data$age_centered^2

# Fit the full model with random intercept and random slope
time_model_full <- lmer(alcuse ~ age_centered + age_centered_sq + (age_centered | id), 
                        data = alcohol_data,
                        control = lmerControl(optimizer = "bobyqa"))
summary(time_model_full)
```

Step 2: Test the random slope
We compare the full model (with random slope) against a model with only a random intercept using a likelihood ratio test. Since we are comparing random effects, we use refit = FALSE to retain REML estimation.


```{r}
# Fit a model with only random intercept
time_model_ri <- lmer(alcuse ~ age_centered + age_centered_sq + (1 | id), 
                      data = alcohol_data,
                      control = lmerControl(optimizer = "bobyqa"))

# Compare models using likelihood ratio test
anova(time_model_ri, time_model_full, refit = FALSE)
```

ImportantQuestion
Based on the likelihood ratio test, is the random slope for time necessary? What does this tell us about whether individuals differ in their rate of change in alcohol use?

K Answer: The random slope for time is necessary (p=0.004757). This tells us that individuals were differed in their rates of change in alcohol use.


Step 3: Calculate the ICC
Regardless of the random slope test result, we calculate the ICC from the random intercept model. This tells us what proportion of the variance in alcohol use (after accounting for time trends) is due to stable differences between individuals.

```{r}
# Extract variance components from the random intercept model
vc <- as.data.frame(VarCorr(time_model_ri))
var_intercept <- vc$vcov[1]
var_residual <- vc$vcov[2]

# Calculate ICC
icc <- var_intercept / (var_intercept + var_residual)
cat("ICC:", round(icc, 3), "\n")
```
Interpret the ICC. What does it tell you about the relative importance of between-person versus within-person variation in alcohol use?

K Answer: The ICC = 0.547 telling that about 54.7% of the variance in alcohol use is due to between-person differences


Step 4: Test the fixed effects for time
Now we test whether the quadratic and linear time components are needed. We use likelihood ratio tests with refit = TRUE because we are comparing models with different fixed effects. We keep the random slope structure throughout.
```{r}
# Test quadratic term: compare model with vs without age_centered_sq
time_model_linear <- lmer(alcuse ~ age_centered + (age_centered | id), data = alcohol_data,
                          control = lmerControl(optimizer = "bobyqa"))
anova(time_model_linear, time_model_full, refit = TRUE)
```

Is the quadratic term significant? What does this tell you about the shape of the average trajectory?

K Answer: No, the quadratic term is not significant. So keep going with linear model


```{r}
# Test linear term: compare model with vs without age_centered
time_model_null <- lmer(alcuse ~ 1 + (age_centered | id), data = alcohol_data,
                        control = lmerControl(optimizer = "bobyqa"))
anova(time_model_null, time_model_linear, refit = TRUE)
```



Step 5: Residual diagnostics
After determining the time structure, we check whether the model adequately captures the time trend by examining the residuals.

```{r}
# Use the final time model (based on tests above, linear model with random slopes)
final_time_model <- time_model_linear

# Create a data frame for plotting
diag_data <- data.frame(
  fitted = fitted(final_time_model),
  residuals = resid(final_time_model)
)

# Residuals vs Fitted using ggplot2
ggplot(diag_data, aes(x = fitted, y = residuals)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linewidth = 1) +
  geom_smooth(method = "loess", se = TRUE, color = "blue", fill = "lightblue") +
  labs(
    title = "Residuals vs Fitted",
    x = "Fitted values",
    y = "Conditional Residuals"
  ) +
  theme_minimal()
```

ImportantQuestion
Does the loess curve (blue line) lie close to zero across the range of fitted values?
K Answer: Yes.

```{r}
# Center peer at its mean for interpretability
alcohol_data$peer_centered <- alcohol_data$peer - mean(alcohol_data$peer, na.rm = TRUE)

# Fit the full model with all predictors and their interactions with time
# Fixed effects: linear time only (quadratic was not significant in Step 4)
# Random effects: intercept and slope for age_centered (based on the test in Step 2)
full_model <- lmer(
  alcuse ~ age_centered * (coa + male + peer_centered) + (age_centered | id),
  data = alcohol_data,
  control = lmerControl(optimizer = "bobyqa")
)
summary(full_model)
```




```{r}
# Use step() to simplify fixed effects
step_result <- step(full_model, reduce.fixed = TRUE, reduce.random = FALSE)
print(step_result)

# Extract the final model
final_model <- get_model(step_result)
```
Based on the output from step(), which fixed effects terms were removed from the model? Does the final model include any interaction effects with time (cross-level interactions), or only main effects?



K Answer: Some fixed effect terms were removed including `age_centered:coa`, and `age_centered:peer_centered`. 

The final model still include interaction effects ( `age_centered:male`)


```{r}
# Display the final model summary
summary(final_model)
```


ImportantQuestion
Based on the final model, what can you conclude about the factors that predict adolescent alcohol use and its change over time? Consider:

Which predictors have significant effects on alcohol use?
Are there differences between groups (e.g., children of alcoholic parents vs. not, sex differences)?
Do any predictors interact with time (age), suggesting different trajectories for different groups?

```{r}
# -----------------------------
# Assumption checks for lmer model
# -----------------------------

# Extract residuals and fitted values
res <- resid(final_model)
fit <- fitted(final_model)

# Residuals vs Fitted Plot
plot(fit, res,
     xlab = "Fitted values",
     ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lwd = 2)

# QQ plot of residuals
qqnorm(res, main = "QQ Plot of Residuals")
qqline(res, col = "red", lwd = 2)

# -----------------------------
# Random Effects Diagnostics
# -----------------------------
library(lme4)

# QQ plots for random effects (BLUPs)
re <- ranef(full_model, drop = TRUE)

# For each random effect term, produce QQ plot
par(mfrow = c(1, length(re)))  # multiple side-by-side

for (i in seq_along(re)) {
  qqnorm(re[[i]][,1],
         main = paste("QQ Plot:", names(re)[i], "Intercept"))
  qqline(re[[i]][,1], col = "red", lwd = 2)
}

# Reset layout
par(mfrow = c(1,1))

```

